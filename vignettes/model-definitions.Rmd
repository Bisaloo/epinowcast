---
title: Model definition and implementation
author: Sam Abbott
output: rmarkdown::html_document
vignette: >
  %\VignetteIndexEntry{Model definitions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```


In the following sections we provide methodological and implementation details for the nowcasting framework implemented in `epinowcast`. Our approach is an extension of that proposed by Gunther et al. which was itself an extension of the model proposed by Hohle and Heiden and implemented in the `surveillance` R package. `epinowcast` adds an optional parametric assumption for the underlying delay from occurance to report, support for jointly nowcasting multiple related datasets, a flexible formula interface allowing for the specification of a large range of models, and an efficient implementation in `stan` which makes use of with-in chain parallisation to reduce runtimes.


# Decomposition into expected final notifications and report delay components

We follow the approach of Hohle and Heiden and consider the distribution of counts ($n_{gtd}$) by time of occurrence ($t$) and reporting delay ($d$) conditional on the final observed count $N_{gt}$ for each dataset ($g$) such that,

\begin{equation}
  N_{gt} = \sum_{d=0}^{D} n_{gtd}
\end{equation}

where $D$ represents the maximum delay between time of occurance and time of report which in theory could be infinite but in practice we set in order to make the model identifiable. This formulation means that $n_{gtd} | N_{gt}$ is multinomial with a probability vector ($p_tgd$) of length $D$ for each $t$ and $g$ that needs to be estimated at the same time as estimating the expected number of final notifications $\mathbb{E}[N_{gt}] = \lambda_{gt}$.

An alternative approach, not explored here, is to consider each $n_{gtd}$ independently at which point the model can be defined as a standard regression with the appropriate observation model and adjustment for reporting delay (i.e it becomes a Poisson or Negative Binomial regression). An implementation of this approach is available in . More work needs to be done to evaluate which of these approaches produces more accurate nowcasts for epidemiological count data.

# Expected final notifications

Here we follow the approach of Gunther et al. and specify the model for expected final notifications as a first order random walk based on the findings of McGough, Johansson, Lipsitch, and Menzies. This model can in principle be any model such as a more complex time-series appproach, a gaussian process, or a mechanistic or semi-mechanistic compartmental model. Extending the flexibility of this model is an area of further work as is evaluating the benefits and tradeoffs of more complex approaches.

\begin{equation}
  \log \lambda_{gt} &\sim \text{Normal}\left(\log\lambda_{gt-1} ,\ \log \lambda_{g0} \sim \text{Normal}\left(\log \lambda_{g0} , 1 \right),
\end{equation}

# Delay distribution

Again following the approach of Gunther et al. we define the delay distribution ($p_gtd$) as a discrete time hazard model ($h_gtd =\text{P} \left(\text{delay}=d|\text{delay} \geq d, W_{gtd}\right)$) but we extend this model to decompose $W_{gtd}$ into 3 components: a parametric delay distribution ($\gamma_{gtd}$) dependent on covariates at the date of occurance, hazard not dependent on a parametric distribution ($\alpha_{gtd}$) dependent on covariates at the date of occurance, and hazard dependent on covariates referenced to the date of report.

\begin{align}
  \text{logit}\left(h_{gtd}\right) &= \gamma_{gtd} + \alpha_{gtd} + \beta{gtd} \\
  \gamma_{gtd} &\sim \text{LogNormal}\left( \right)
\end{align}

# Observation model and nowcast

\begin{align}
  n_{gtd} | \lambda_{gt},p_{gtd}  &\sim \text{NB}(\lambda_{gt} \times p{gtd}, \phi),\ t=1,...,T. \\
  N_{gt} &= \sum_{d=0}^{D} n_{gtd}
\end{align}



# Implementation



# References
