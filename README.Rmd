---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# Nowcast right censored epidemological counts

[![R-CMD-check](https://github.com/seabbs/epinowcast/workflows/R-CMD-check/badge.svg)](https://github.com/seabbs/epinowcast/actions/workflows/R-CMD-check.yaml) [![Codecov test coverage](https://codecov.io/gh/seabbs/epinowcast/branch/main/graph/badge.svg)](https://app.codecov.io/gh/seabbs/epinowcast)

[![GitHub contributors](https://img.shields.io/github/contributors/seabbs/epinowcast)](https://github.com/seabbs/epinowcast/graphs/contributors) 

This package contains tools to enable flexible and efficient nowcasting of  right censored epidemiological counts using a semi-mechanistic method with adjustment available for both day of reference and day of report effects. 

## Installation


### Installing the package

Install the unstable development from GitHub using the following, 

```{r, eval = FALSE}
remotes::install_github("seabbs/epinowcast", dependencies = TRUE)
```

### Installing CmdStan

If you don't already have CmdStan installed then, in addition to installing `epinowcast`, it is also necessary to install CmdStan using CmdStanR's 
`install_cmdstan()` function to enable model fitting in `epinowcast`. A suitable C++ toolchain is also required. Instructions are provided in the [_Getting started with
CmdStanR_](https://mc-stan.org/cmdstanr/articles/cmdstanr.html) vignette. See the [CmdStanR documentation](https://mc-stan.org/cmdstanr/) for further details and support. 

```{r, eval = FALSE}
cmdstanr::install_cmdstan()
```

## Quick start

### Example data

```{r}
library(epinowcast)
library(ggplot2)

national_germany_hosp <- germany_covid19_hosp
national_germany_hosp <- national_germany_hosp[location == "DE"]
national_germany_hosp <- national_germany_hosp[age_group %in% "00+"]

nat_germany_30_days_ago <-
  national_germany_hosp[report_date <= max(report_date) - 30]
nat_germany_30_days_ago <-
  nat_germany_30_days_ago[reference_date >= (max(reference_date) - 30)]
nat_germany_30_days_ago[]
```

```{r}
latest_germany_hosp <- national_germany_hosp[report_date == max(report_date)]

latest_germany_hosp <-
  latest_germany_hosp[reference_date >= (max(reference_date) - 60)]
latest_germany_hosp <-
  latest_germany_hosp[reference_date <= (max(reference_date) - 30)]
latest_germany_hosp[]
```

### Data preprocessing and model specification

Process reported data into format required for `{epinowcast}` and return in a `{data.table}`. At this stage specify grouping (i.e age, location) if any.

```{r}
pobs <- enw_preprocess_data(nat_germany_30_days_ago, max_delay = 30)
pobs
```

Construct an intercept only model for the date of reference.

```{r}
reference_effects <- enw_intercept_model(pobs$metareference[[1]])
reference_effects
```

Construct a model with a random effect for the day of report.
```{r}
report_effects <- enw_day_of_week_model(pobs$metareport[[1]])
report_effects
```

### Model fitting

First compile the model. This step can be left to `epinowcast` but here we want to use multiple cores per chain to speed up model fitting and so need to compile the model with this feature turned on.
```{r}
model <- enw_model(threads = TRUE)
```

We now fit the model and produce a nowcast using this fit. Note that here we use two chains each using two threads as a demonstration but in general using 4 chains is recommended. Also note that here we have silenced fitting progress and potential warning messages for the purposes of keeping this quick start short but in general this should not be done.

```{r}
options(mc.cores = 2)
nowcast <- epinowcast(pobs,
  model = model,
  report_effects = report_effects,
  reference_effects = reference_effects,
  save_warmup = FALSE, pp = TRUE,
  chains = 2, threads_per_chain = 2,
  show_messages = FALSE
)
```

### Results

Print the output from `{epinowcast}` which includes diagnostic information, the data used for fitting, and the `{cmdstanr`} object.

```{r}
nowcast
```

Summarise the nowcast for the latest snapshot of data.

```{r}
summary(nowcast, probs = c(0.05, 0.95))
```

Plot the summarised nowcast against currently observed data (or optionally more recent data for comparison purposes).

```{r}
plot(nowcast, obs = latest_germany_hosp)
```

Plot posterior predictions for observed notifications by date of
report as a check of how well the model reproduces the observed data.

```{r, fig.width = 16, fig.height = 16, message = FALSE}
plot(nowcast, type = "posterior")
```

## Citation

If using `epinowccast` in your work please consider citing it using the following,

```{r, echo = FALSE}
citation("epinowcast")
```

## How to make a bug report or feature request

Please briefly describe your problem and what output you expect in an [issue](https://github.com/seabbs/epinowcast/issues). If you have a question, please don't open an issue. Instead, ask on our [Q and A page](https://github.com/seabbs/epinowcast/discussions/categories/q-a).

## Contributing

We welcome contributions and new contributors! We particularly appreciate help on priority problems in the [issues](https://github.com/seabbs/epinowcast/issues). Please check and add to the issues, and/or add a [pull request](https://github.com/seabbs/epinowcast/pulls).

## Code of Conduct
  
Please note that the `forecast.vocs` project is released with a [Contributor Code of Conduct](samabbott.co.uk/epinowcast/CODE_OF_CONDUCT.html). By contributing to this project, you agree to abide by its terms.
